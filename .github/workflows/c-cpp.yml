name: C/C++ CI

on:
  workflow_dispatch:
  push:
    branches: [master]
    paths-ignore:
      - '**.md'
      - 'wiki/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/FUNDING.yml'
      - '.github/CODE_OF_CONDUCT.md'
      - '.github/CONTRIBUTING.md'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'wiki/**'

# Cancel older in-progress runs for the same branch/PR ref.
# This reduces wasted CI minutes when multiple pushes happen quickly.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Set least-privilege defaults for all jobs
permissions:
  contents: read

jobs:
  build-macOS:
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 45
    permissions:
      contents: read
      actions: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: x86_64
            runner: macos-15-intel
            arch: intel
            artifact_name: amiberry-macOS-x86_64-intermediate
          - name: Apple-Silicon
            runner: macos-15
            arch: apple-silicon
            artifact_name: amiberry-macOS-arm64-intermediate
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Cache Homebrew
        if: matrix.arch == 'intel'
        uses: actions/cache@v4
        with:
          path: /usr/local/Homebrew
          key: ${{ runner.os }}-brew-${{ hashFiles('Brewfile') }}
          restore-keys: |
            ${{ runner.os }}-brew-

      - name: Fix homebrew in Github Runner
        if: matrix.arch == 'intel'
        run: |
          for f in $(find /usr/local/bin -type l -print); do \
            (readlink $f | grep -q -s "/Library") && echo Removing "$f" && rm -f "$f"; \
          done || exit 0

      - name: Pre-install gobject-introspection from source
        if: matrix.arch == 'intel'
        run: brew install --build-from-source gobject-introspection

      - name: Install dependencies (Homebrew - Intel)
        if: matrix.arch == 'intel'
        run: |
          brew update && \
          if [ -f Brewfile ]; then brew bundle; else brew install sdl2 mpg123 sdl2_ttf sdl2_image flac libmpeg2 libserialport portmidi enet libpcap zstd dylibbundler; fi

      - name: Install dependencies (Homebrew - Apple Silicon)
        if: matrix.arch == 'apple-silicon'
        run: |
          brew update
          brew install sdl2 mpg123 sdl2_ttf sdl2_image flac libmpeg2 libserialport portmidi enet libpcap zstd dylibbundler

      - name: Build for macOS (${{ matrix.name }})
        run: |
          cmake -B build && cmake --build build -j$(sysctl -n hw.ncpu)

      - name: Upload intermediate app bundle
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: build/Amiberry.app
          retention-days: 1

  merge-macOS-universal:
    needs: [build-macOS]
    runs-on: macos-15
    timeout-minutes: 30
    permissions:
      contents: read
      actions: write
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Download x86_64 app bundle
        uses: actions/download-artifact@v4
        with:
          name: amiberry-macOS-x86_64-intermediate
          path: x86_64-app/Amiberry.app

      - name: Download arm64 app bundle
        uses: actions/download-artifact@v4
        with:
          name: amiberry-macOS-arm64-intermediate
          path: arm64-app/Amiberry.app

      - name: Create Universal binary with lipo
        run: |
          set -euo pipefail

          mkdir -p universal-app/Amiberry.app

          # Start with the arm64 app as the base (preserves bundle structure)
          cp -R arm64-app/Amiberry.app/ universal-app/Amiberry.app/

          # Merge the main executable
          lipo -create \
            x86_64-app/Amiberry.app/Contents/MacOS/Amiberry \
            arm64-app/Amiberry.app/Contents/MacOS/Amiberry \
            -output universal-app/Amiberry.app/Contents/MacOS/Amiberry

          # Helper: merge a single binary with lipo, skipping if already universal
          merge_binary() {
            local x86_file="$1" arm_file="$2" output="$3"
            if [ ! -f "$x86_file" ] || [ ! -f "$arm_file" ]; then
              return
            fi
            # If a file is already universal (e.g. capsimage builds fat), just copy it
            local x86_archs arm_archs
            x86_archs=$(lipo -info "$x86_file" 2>/dev/null | sed 's/.*: //')
            arm_archs=$(lipo -info "$arm_file" 2>/dev/null | sed 's/.*: //')
            if echo "$x86_archs" | grep -q "x86_64" && echo "$x86_archs" | grep -q "arm64"; then
              echo "  Already universal: $(basename "$output") — copying as-is"
              cp "$x86_file" "$output"
            elif [ "$x86_archs" = "$arm_archs" ]; then
              echo "  WARNING: same arch in both — copying x86 version: $(basename "$output")"
              cp "$x86_file" "$output"
            else
              lipo -create "$x86_file" "$arm_file" -output "$output"
            fi
          }

          # Merge all dylibs in Frameworks
          for dylib in universal-app/Amiberry.app/Contents/Frameworks/*.dylib; do
            basename=$(basename "$dylib")
            merge_binary \
              "x86_64-app/Amiberry.app/Contents/Frameworks/$basename" \
              "arm64-app/Amiberry.app/Contents/Frameworks/$basename" \
              "$dylib"
          done

          # Merge all dylibs in plugins
          if [ -d "universal-app/Amiberry.app/Contents/Resources/plugins" ]; then
            for dylib in universal-app/Amiberry.app/Contents/Resources/plugins/*.dylib; do
              basename=$(basename "$dylib")
              merge_binary \
                "x86_64-app/Amiberry.app/Contents/Resources/plugins/$basename" \
                "arm64-app/Amiberry.app/Contents/Resources/plugins/$basename" \
                "$dylib"
            done
          fi

          # Verify the main binary is universal
          echo "=== Universal binary info ==="
          lipo -info universal-app/Amiberry.app/Contents/MacOS/Amiberry
          file universal-app/Amiberry.app/Contents/MacOS/Amiberry

      - name: Install the Apple certificate
        env:
          APPLE_DEVID_CERT_BASE64: ${{ secrets.APPLE_DEVID_CERT_BASE64 }}
          APPLE_DEVID_CERT_P12_PASSWORD: ${{ secrets.APPLE_DEVID_CERT_P12_PASSWORD }}
          APPLE_KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
        run: |
          set +x  # Mask output for security
          CERTIFICATE_PATH=$RUNNER_TEMP/apple_devid_cert.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          echo -n "$APPLE_DEVID_CERT_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          security create-keychain -p $APPLE_KEYCHAIN_PASSWORD $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p $APPLE_KEYCHAIN_PASSWORD $KEYCHAIN_PATH
          security import $CERTIFICATE_PATH -P $APPLE_DEVID_CERT_P12_PASSWORD -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k $APPLE_KEYCHAIN_PASSWORD $KEYCHAIN_PATH
          security list-keychains -d user -s $KEYCHAIN_PATH

      - name: Codesign the dylibs
        run: |
          for file in universal-app/Amiberry.app/Contents/Frameworks/*.dylib; do
            if [ -f "$file" ]; then
              codesign -s "Developer ID Application: Dimitris Panokostas (5GQP72592A)" -f -o runtime,hard "$file"
            fi
          done
          for file in universal-app/Amiberry.app/Contents/Resources/plugins/*.dylib; do
            if [ -f "$file" ]; then
              codesign -s "Developer ID Application: Dimitris Panokostas (5GQP72592A)" -f -o runtime,hard "$file"
            fi
          done

      - name: Codesign the app
        run: |
          codesign -s "Developer ID Application: Dimitris Panokostas (5GQP72592A)" -f -o runtime,hard universal-app/Amiberry.app

      - name: Create a zip to send to the notary service
        run: |
          zip -r Amiberry-${{ github.sha }}-macOS-universal.zip universal-app/Amiberry.app

      - name: Send the file to be notarized by Apple
        run: |
          xcrun notarytool submit Amiberry-${{ github.sha }}-macOS-universal.zip --wait --apple-id "midwan@gmail.com" --password ${{ secrets.APPLE_NOTARY_APP_PASSWORD }} --team-id ${{ secrets.APPLE_TEAM_ID }}

      - name: Staple the notary receipt to the application bundle
        run: |
          xcrun stapler staple universal-app/Amiberry.app
          rm Amiberry-${{ github.sha }}-macOS-universal.zip

      - name: Create DMG package
        run: |
          set -euo pipefail

          # Read version from CMakeLists.txt (BSD-compatible, no grep -P)
          VERSION=$(sed -n 's/.*VERSION \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/p' CMakeLists.txt | head -1)
          PRE_RELEASE=$(sed -n 's/.*VERSION_PRE_RELEASE "\([0-9]*\)".*/\1/p' CMakeLists.txt | head -1)
          if [ -n "$PRE_RELEASE" ]; then
            DMG_VERSION="${VERSION}~pre${PRE_RELEASE}"
          else
            DMG_VERSION="${VERSION}"
          fi
          DMG_NAME="Amiberry-${DMG_VERSION}-Darwin"

          # Create a staging directory for DMG contents
          STAGING="dmg-staging"
          mkdir -p "$STAGING"
          cp -R universal-app/Amiberry.app "$STAGING/"
          ln -s /Applications "$STAGING/Applications"

          # Copy background image
          mkdir -p "$STAGING/.background"
          cp packaging/dmg/AppDMGBackground.tiff "$STAGING/.background/background.tiff"

          # Create the DMG
          hdiutil create -volname "Amiberry" \
            -srcfolder "$STAGING" \
            -ov -format UDZO \
            "${DMG_NAME}.dmg"

          echo "DMG_NAME=${DMG_NAME}" >> "$GITHUB_ENV"

      - name: ZIP package for release
        if: github.ref_type == 'tag'
        run: zip -r Amiberry-${{ github.ref_name }}-macOS-universal.zip ${DMG_NAME}.dmg

      - name: Upload artifact
        if: github.ref_type != 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: amiberry-macOS-universal
          path: Amiberry-*.dmg
          retention-days: 7

      - name: Upload artifact for release
        if: github.ref_type == 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: amiberry-macOS-universal
          path: Amiberry-*.zip
          retention-days: 7

  build-ubuntu:
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}
    timeout-minutes: 30
    permissions:
      contents: read
      actions: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 22.04-amd64
            runner: ubuntu-latest
            container: ubuntu:22.04
            artifact_name: amiberry-ubuntu-22.04-amd64
          - name: 24.04-amd64
            runner: ubuntu-latest
            container: ubuntu:24.04
            artifact_name: amiberry-ubuntu-24.04-amd64
          - name: 25.10-amd64
            runner: ubuntu-latest
            container: ubuntu:25.10
            artifact_name: amiberry-ubuntu-25.10-amd64
          - name: 25.10-arm64
            runner: ubuntu-24.04-arm
            container: ubuntu:25.10
            artifact_name: amiberry-ubuntu-25.10-arm64
    steps:
      - name: Install prerequisites
        run: |
          apt-get update
          apt-get install -y sudo git

      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Install ccache
        run: sudo apt-get install -y ccache

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-${{ matrix.name }}-ccache-${{ github.ref }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.name }}-ccache-${{ github.ref }}-
            ${{ runner.os }}-${{ matrix.name }}-ccache-

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-${{ matrix.name }}-apt-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.name }}-apt-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build file libflac-dev libmpeg2-4-dev libpng-dev libsdl2-dev libsdl2-ttf-dev libsdl2-image-dev libasound2-dev libmpg123-dev libportmidi-dev libserialport-dev libenet-dev libpcap-dev libzstd-dev

      - name: make for Ubuntu ${{ matrix.name }}
        env:
          CCACHE_DIR: ~/.ccache
        run: |
          export PATH="/usr/lib/ccache:$PATH"
          cmake -B build -G Ninja -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache && cmake --build build -j$(nproc)
          cpack -G DEB --config build/CPackConfig.cmake

      - name: Upload artifact
        if: always() && github.ref_type != 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: amiberry_*.deb
          retention-days: 7

      - name: ZIP package for release
        if: github.ref_type == 'tag'
        run: zip -r ${{ matrix.artifact_name }}.zip amiberry_*.deb

      - name: Upload artifact for release
        if: always() && github.ref_type == 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: amiberry-*.zip

  build-fedora:
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    permissions:
      contents: read
      actions: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: x86_64
            runner: ubuntu-latest
            image: midwan/amiberry-fedora-x86_64:latest
            artifact_name: amiberry-fedora-x86_64
            release_suffix: fedora-x86_64
          - name: aarch64
            runner: ubuntu-24.04-arm
            image: midwan/amiberry-fedora-arm64:latest
            artifact_name: amiberry-fedora-aarch64
            release_suffix: fedora-aarch64
    steps:
    - uses: actions/checkout@v4

    - name: Run the build process with Docker
      run: |
        docker run --rm -v ${{ github.workspace }}:/build ${{ matrix.image }} \
          bash -c "cmake -B build -G Ninja -DCMAKE_INSTALL_PREFIX=/usr && cmake --build build -j\$(nproc) && cpack -G RPM --config build/CPackConfig.cmake"

    - name: Upload artifact
      if: always() && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: amiberry-*.rpm
        retention-days: 7

    - name: ZIP package for release
      if: github.ref_type == 'tag'
      run: zip -r amiberry-${{ github.ref_name }}-${{ matrix.release_suffix }}.zip amiberry-*.rpm

    - name: Upload artifact for release
      if: always() && github.ref_type == 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: amiberry-*.zip

  build-debian-amd64:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: bookworm
            image: midwan/amiberry-debian-x86_64:bookworm
            artifact_name: amiberry-debian-bookworm-amd64
            release_name: debian-bookworm-amd64
          - name: trixie
            image: midwan/amiberry-debian-x86_64:trixie
            artifact_name: amiberry-debian-trixie-amd64
            release_name: debian-trixie-amd64
    steps:
      - uses: actions/checkout@v4

      - name: Run the build process with Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/build ${{ matrix.image }} \
            bash -c "cmake -B build -G Ninja -DCMAKE_INSTALL_PREFIX=/usr && cmake --build build -j\$(nproc) && cpack -G DEB --config build/CPackConfig.cmake"

      - name: Upload artifact
        if: always() && github.ref_type != 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: "amiberry_*.deb"
          retention-days: 7

      - name: ZIP package for release
        if: github.ref_type == 'tag'
        run: zip -r "amiberry-${{ github.ref_name }}-${{ matrix.release_name }}.zip" amiberry_*.deb

      - name: Upload artifact for release
        if: always() && github.ref_type == 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: "amiberry-*.zip"

  build-debian-arm64:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: bookworm
            image: midwan/amiberry-debian-aarch64:bookworm
            artifact_name: amiberry-debian-bookworm-arm64
            release_name: debian-bookworm-arm64
          - name: trixie
            image: midwan/amiberry-debian-aarch64:trixie
            artifact_name: amiberry-debian-trixie-arm64
            release_name: debian-trixie-arm64
    steps:
    - uses: actions/checkout@v4

    - name: Run the build process with Docker
      run: |
        docker run --rm -v ${{ github.workspace }}:/build ${{ matrix.image }} \
          bash -c "cmake -DCMAKE_TOOLCHAIN_FILE=cmake/Toolchain-aarch64-linux-gnu.cmake -B build -G Ninja -DCMAKE_INSTALL_PREFIX=/usr && cmake --build build -j\$(nproc) && cpack -G DEB --config build/CPackConfig.cmake"

    - name: Upload artifact
      if: always() && github.ref_type != 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: "amiberry_*.deb"
        retention-days: 7

    - name: ZIP package for release
      if: github.ref_type == 'tag'
      run: zip -r amiberry-${{ github.ref_name }}-${{ matrix.release_name }}.zip amiberry_*.deb

    - name: Upload artifact for release
      if: always() && github.ref_type == 'tag'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: "amiberry-*.zip"

  build-windows:
    runs-on: windows-latest
    timeout-minutes: 45
    permissions:
      contents: read
      actions: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: x64
            artifact_name: amiberry-windows-x64
            release_suffix: windows-x64
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja

      - name: Cache vcpkg installed packages
        uses: actions/cache@v4
        with:
          path: out/build/windows-release/vcpkg_installed
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Build for Windows (${{ matrix.name }})
        shell: msys2 {0}
        env:
          VCPKG_ROOT: C:/vcpkg
        run: |
          cmake --preset windows-release
          cmake --build out/build/windows-release -j$(nproc)

      - name: Package
        shell: msys2 {0}
        run: |
          # Copy MinGW runtime DLLs next to the executable
          cp /mingw64/bin/libstdc++-6.dll out/build/windows-release/
          cp /mingw64/bin/libgcc_s_seh-1.dll out/build/windows-release/
          cp /mingw64/bin/libwinpthread-1.dll out/build/windows-release/
          # Create ZIP package
          cpack -G ZIP --config out/build/windows-release/CPackConfig.cmake

      - name: Upload artifact
        if: github.ref_type != 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: amiberry-*.zip
          retention-days: 7

      - name: Upload artifact for release
        if: github.ref_type == 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: amiberry-*.zip
          retention-days: 7

  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
    env:
      # Keep Gradle state inside the workspace so actions/cache can persist it reliably.
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
    steps:
      - uses: actions/checkout@v4

      - name: Cache Gradle (wrapper + caches)
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.GRADLE_USER_HOME }}/caches
            ${{ env.GRADLE_USER_HOME }}/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('android/**/gradle-wrapper.properties', 'android/**/*.gradle*', 'android/gradle.properties', 'android/settings.gradle', 'android/build.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Note: Android dependencies are fetched via CMake FetchContent during the native build,
      # so we no longer download SDL2_image/SDL2_ttf vendored third-party sources here.

      - name: set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Build with Gradle
        run: |
          cd android
          ./gradlew --no-daemon --stacktrace --warning-mode all assembleDebug assembleRelease bundleRelease

      - name: Collect Android outputs
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          mkdir -p artifacts
          # Copy outputs rather than renaming in-place (AGP may produce multiple variants).
          VERSION_SUFFIX="${{ github.ref_type == 'tag' && github.ref_name || github.sha }}"

          if compgen -G "android/app/build/outputs/apk/debug/*.apk" > /dev/null; then
            for f in android/app/build/outputs/apk/debug/*.apk; do
              cp -v "$f" "artifacts/amiberry-android-${VERSION_SUFFIX}-debug.apk"
            done
          fi
          if compgen -G "android/app/build/outputs/apk/release/*.apk" > /dev/null; then
            for f in android/app/build/outputs/apk/release/*.apk; do
              cp -v "$f" "artifacts/amiberry-android-${VERSION_SUFFIX}-release.apk"
            done
          fi
          # Also collect AABs if present
          if compgen -G "android/app/build/outputs/bundle/**/*.aab" > /dev/null; then
             for f in android/app/build/outputs/bundle/**/*.aab; do
                cp -v "$f" "artifacts/amiberry-android-${VERSION_SUFFIX}.aab"
             done
          fi

      - name: Upload Android artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: amiberry-android-${{ github.ref_type == 'tag' && github.ref_name || github.sha }}
          path: |
            artifacts/*
          if-no-files-found: error
          retention-days: 7

      - name: Upload Android build reports (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: amiberry-android-reports-${{ github.sha }}
          path: |
            android/app/build/reports/**
            android/app/build/logs/**
          if-no-files-found: warn

  create-release:
    needs: [merge-macOS-universal, build-fedora, build-ubuntu, build-debian-amd64, build-debian-arm64, build-windows, build-android]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.ref_type == 'tag' && (startsWith(github.ref_name, 'v') || startsWith(github.ref_name, 'preview-v'))
    # Elevated permissions only where needed for creating a release
    permissions:
      contents: write
      actions: read
      pull-requests: read
      issues: read
    steps:
      - uses: actions/checkout@v4

      - name: Create Changelog
        id: changelog
        uses: loopwerk/tag-changelog@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config_file: .github/tag-changelog-config.js

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          prerelease: ${{ startsWith(github.ref_name, 'preview-v') }}
          allowUpdates: true
          omitBodyDuringUpdate: true
          body: ${{ steps.changelog.outputs.changes }}
          artifacts: |
            artifacts/amiberry-*.zip
            artifacts/Amiberry-*.zip
            artifacts/*.apk
            artifacts/*.aab
